# SimStr
A pipeline to generate simulation datasets for evaluation on strain analysis from metagenomic data

# Install and activate the environment

Pull the docker of SimStr from docker hub

```
docker pull yuxiangtan/simstr
```

User can get into the interactive mode by: 

```shell
docker run  -u $(id -u):$(id -g) --rm -t -i -v /home:/home -v $Path_to_SimStr/:/script -w /home yxtan/simstr:v1 /bin/bash
```

In this case, all the Path_to_SimStr in the following guideline could be replaced by /script/. For exampe, within the docker: **Path_to_SimStr="/script/“**

# Workflow

## 1. Generate the list of candidate strains (with paired WGS data) of a specific species:

For this step, -u option of docker run might lead to the fail of fastq-dump, you can use  "docker run --rm -t -i -v /home:/home -v $Path_to_SimStr/:/script -w /home yxtan/simstr:v1 /bin/bash" instead. However, all the files will be marked "root" as username. 

Usage: sh $Path_to_SimStr/SIM_str_ANI_PAN_mash.sh sra_result.csv SraRunInfo.csv strs.csv fileout_header $Path_to_SimStr range_type min_ANI
    

    Required: (all of these files need to be download manually)
    	sra_result.csv: from https://www.ncbi.nlm.nih.gov/sra/, select the target species and select the sent to (top right) -> file -> save summary.
    	SraRunInfo.csv: from https://www.ncbi.nlm.nih.gov/sra/, select the target species and select the sent to (top right) -> file -> save Runinfo.
    	strs.csv: from https://www.ncbi.nlm.nih.gov/genome/browse/#!/prokaryotes/, select the target species; Select all the strains or subset of the target strains; click download
    	fileout_header: name of output files. For example: Ecoli99_target_str_info 
    	Path_to_SimStr: the full path of SimStr scripts folder. Within the docker, it should be /script/
        range_type - 'wide' which will get the combination with the widest range of ANIs; or 'max ANI value (e.g. 99)' which will get all the strs combinations with ANI smaller or equal to that value, the bigger this value, the more strs you will get.
        min_ANI - the min ANI allowed for simulation, ANI>=95 is considered as within species.

​    	There are three main steps of this part of pipeline:1. Extract all the strains in the list and automatically download the data from database;2. Generate the pangenome database to get the gene content similarity to calculate pairwise Jaccard distance among strains and calculate pairwise ANI (Average Nucleotide Identity = 1 - mash ) distance among strains by mash; 3. Extract candidate strains within the ANI range and generate their pairwise ANI and AJI (Average Jaccard distance Identity). The paired WGS data of these candidate strains will also be downloaded. 

​		If the first part of pangenome generation finished, and you do not want to rerun the first part, you can run SIM_str_ANI_PAN_mash_part2.sh instead of SIM_str_ANI_PAN_mash.sh.

Key outputs: 

​			SIM_ART_matrix.csv: the path of genome ref data of strains to be selected from. 

​			SIM_WGS_matrix.csv: the path of WGS data of strains to be selected from. 

​			AJI_SIM_strain.csv: the pairwise Jaccard distance of the SIM candidate strains in the SIM_xxx_matrix.csv.

​			ANI_SIM_strain.csv: the pairwise ANI (1- mash) of the SIM candidate strains in the SIM_xxx_matrix.csv.

Other statistical outputs:

​			AJI_allref_strain.csv: the pairwise Jaccard distance of gene contents of all reference genomes.

​			ANI_allref_strain.csv: the pairwise ANI (1 - mash) of gene contents of all reference genomes.

​			*.pdf: statistical plots.

Intermediate output folders:

​			strain-ref: all selected reference genome from strs.csv with their paired gff files will be downloaded here

​			target_species, fna_from_gff, gff_added_fna, ffn_from_gff : are all folders generated by panphlan.  



**NOTE 1! Each simulation must run in separated folder, otherwise the references data will disturb each other.** 

**NOTE 2! If the panphlan failed, need to delete all the panphlan related output and rerun the pipeline (generally, this is caused by the disconnection of download, or users could download first and run panphlan separately), or panphlan will crash again because of the existing files.**

**NOTE 3! If the panphlan failed, need to delete all the panphlan related output and rerun the pipeline (generally, this is caused by the disconnection of download, or users could download first and run panphlan separately), or panphlan will crash again because of the existing files.**

**NOTE 4! SraRunInfo.csv and strs.csv must be the newest one, or the link might be expired and failed.**

## 2. Manual step: Select the target strains for simulation based on pairwise ANI and AJI, together with generation of composition matrix for simulation.

Once the target strains were selected based on certain criteria (such as ANI or AJI range), composition matrix for simulation could be manually generated, following the format of benchmark_comp_ART_1x.csv and benchmark_comp_WGS_1x.csv in Example_files folder.

The common rule is that: in rows, the first two rows are header and depth unit setting and the following rows are for each strain selected; in columns, the first part (3 or 5 columns depending on simulation type) is annotation, and the second part is the composition of samples (1 sample per column)  

For ART simulation: in benchmark_comp_ART_1x.csv, 1st column should be Taxa_name or artifact strain ID, 2nd column should be Strain_ID_prefix in GCF or GCA format, 3rd column is the local path for fa files. The info of 2nd and 3rd column could be directly extract from the SIM_ART_matrix.csv.

For WGS simulation: in benchmark_comp_WGS_1x.csv, 1st column should be Taxa_name or artifact strain ID, 2nd column should be Strain_ID_prefix in GCF or GCA format, 3rd column is the local path prefix for WGS fq files, 4th column is the sizes of the reference genome of selected strains for depth calcuation, 5th column is the read length of each WGS data. The info of 2nd and 4rd column could be directly extract from the SIM_WGS_matrix.csv. For the 5th column, the read length information could be extract from fastqc or the read len annotation of reads in the fastq files.

For the second part of columns, if the composition should follow the Dirichlet distribution, Dirichlet_composition_generator.R could be used to generate the matrix by input the number of strains, the number of samples and the sum of depth unit. (see dist_table_4strs_20sample.csv as example). If not, you can put the composition as you want for each strain in each sample.

## 3. Generate simulation data by the composition matrix.

By using the composition matrix generated from step 2, you can automatically generate the simulation data.

For this step, if the -u option of docker run lead to the incorrect username (uid or gid unrecognized), the program will fail. In this case just do not use the -u option same as step 1. 

#### For ART simulation: by using the ART matrix (benchmark_comp_ART_1x.csv as example) as input:	

```shell
python $Path_to_SimStr/Strain_list_merger.py -i benchmark_comp_ART_1x.csv -D $Path_to_SimStr --sf /art_bin_MountRainier/ -o outfolder
```

​	The outfolder should be generated before hand to avoid unexpected mistake. 	

​	/art_bin_MountRainier/ is the path where the art_illumina command is in the docker

**NOTE ! The path in the benchmark_comp_ART_1x.csv must be available in docker, for example, /home/ is set in the start of docker.** 

#### For WGS simulation: by using the WGS matrix (benchmark_comp_WGS_1x.csv as example) as input:	

```shell
python $Path_to_SimStr/Strain_list_merger_WGS.py -i benchmark_comp_WGS_1x.csv -D $Path_to_SimStr -o outfolder
```

​	The outfolder should be generated before hand to avoid unexpected mistake. 

**NOTE ! The path in the benchmark_comp_WGS_1x.csv must be available in docker, for example, /home/ is set in the start of docker.** 

Optional parameters:

	'-a', '--ss',  type=str, default='HS25', "The sequencer modle of ART"
	'-l', '--length',type=int, default='150',"The length of simulated reads"
	'-m', '--mean_frag', type=int, default='270',"The expected mean of length of simulated fragment size"
	'-s', '--std_frag', type=int, default='27',"The expected std of length of simulated fragment size"
	'-r', '--rep_num',type=int, default='3',"The number of replicates samples"

In the output folder, three folders will be generated:

​		dist_csv: distribution of each sample

​		raw_sim: raw simulated reads of strains are in raw_sim folder. Each sample has its prefix name as subfolder name with each replicate inside

​		final_fq: the folder of all merged pair-end fq, each pair stands for one replicate of each sample. The error type: errfree, seqerr and WGSerr are marked in the sample names.

#### Also, a relative abundance ground truth file will be generated for each set of simulation. For example: benchmark_comp_WGS_errfree_all_str_prof_4str.csv for errfree samples, benchmark_comp_WGS_seqerr_all_str_prof_4str.csv for ART simulated errors, benchmark_comp_WGS_WGSerr_all_str_prof_4str.csv for WGS dataset. 

**NOTE ! Each simulation must run in a empty folder, otherwise the simulation will be merged together with the previous one.** 



## 4. Evaluation by using the composition matrix as the ground truth.

After running the strain analysis, we can evaluate the output matrix by converting them into a standard format.

For output from tools like StrainPanDA or StrainEst, which with strain ID annotation in GCA or GCF format across samples, we can obtain the correctness of the predicted strain by a defined range of distance. Otherwise, for tools such as PStrain, the correctness of strain prediction is not available.

### 4.1 Convert the output into a standard format

#### For StrainPanDA, not conversion is necessary.

#### For StrainEst, the output from each sample need to be merged together into one matrix with rows as strains and columns as samples.

```
#you can run StrainEst by the following pipeline (the docker of StrainEst should be installed and activated)
mkdir Est_run
time python $Path_to_SimStr/run_Est_samples.py -i EST_files.csv -p $Path_to_ESTindex/E_coli/bowtie/align -d $Path_to_ESTindex/E_coli/snp_clust.dgrp -o Est_run 1>Est_run.log 2>Est_FMT.log
```

$Path_to_ESTindex is path to the index of StrainEst downloaded or generated into.

EST_files.csv is the path of simulation fqs, which can be easily generated by : 

```
Rscript $Path_to_SimStr/generate_Est_list.R wfd=$Path_to_final_fq fq_reg=_1.fq #Path_to_final_fq is the path to the final_fq from the simulation
```

Then, within the Est_run folder, you can automatically generate a merge file by the following command:

```
cp $Path_to_SimStr/merge_Est.R .
bash $Path_to_SimStr/Est_downstream.sh
```

#### For PStrain, the output from each sample need to be merged together and then separated into matrix of each species with rows as strains and columns as samples.

```
#you can run StrainEst by the following pipeline (PStrain must be setup following its github: https://github.com/wshuai294/PStrain)
time python $Path_to_PStrain/PStrain/PStrain.py -c fq_list.txt -o PS_out 1>run.log 2>err.log

```

fq_list.txt is the path of simulation fqs, which can be easily generated by : 

```
Rscript $Path_to_SimStr/generate_constrain_list.R wfd=$Path_to_final_fq fq_reg=_1.fq #Path_to_final_fq is the path to the final_fq from the simulation

```

Then, within the current folder, you can automatically generate merge files for species by the following command:

```
grep "sample:" fq_list.txt | cut -f2 -d":" > sample_list.txt 
cd PS_out
Rscript $Path_to_SimStr/merge_PStrain_RA.R
cd ..
```



#### 4.2 run evaluation for single method to generate statistic matrices

```
Rscript $Path_to_SimStr/SIM_evaluate_unifrac_denovo.R bench_tb=ground_truth_ratio_file method_anno_tb=out_from_strain_analysis denovo_ref=str_list_file tree_nwk=parsnp_tree name_out=outheader str_match=FALSE

```

ground_truth_ratio_file: the file generate in step3, for example :benchmark_comp_WGS_WGSerr_all_str_prof_4str.csv

out_from_strain_analysis: file generated in step 4.1. For StrainPanDA, it should be in species.xstrain_str_anno_prof.csv format, e.g. Escherichia-coli-202009.xstrain_str_anno_prof.csv. For StrainEst, it is Est_merged_matrix.tsv. For PStrain, it should be in species_PStrian_merged_RA.csv format, e.g. Escherichia_coli_PStrian_merged_RA.csv

str_list_file: the file used to generate the database, should start with GCF or GCA format, see Est_str_list.txt as example (The file will be neglected if str_match=FALSE)

parsnp_tree: the tree output from parsnp, see parsnp.tree as example. (The file will be neglected if str_match=FALSE)

outheader: the prefix of out files.

str_match: for StrainPanDA or StrainEst, it is true as defaut, for PStrain is must be false because there is no strain annotation to match.

dist_range: (optional) the parsnp distance for ANI=99 various for species, for example, it is 0.05 as default for E.coli, but it should be 0.2 for B.lougum

Parsnp tree generation:

```
sh $Path_to_SimStr/ref_tree_generator.sh ref_list_files ref_tb name_out $Path_to_SimStr . num_proc
```

Parsnp tree is used to define distance between predicted to the ground truth to decide whether the predicted strain is correct.

ref_list_files: see ref_list_files.txt as example,  generally, it should include all the files of databases to be consider. Each database should have a list of GCFs. Also, the list of strains used for simulation should be included  as well. (All dependent files are in Example_files)

ref_tb: generally, it is same as strs.csv in step 1, see Ecoli_strs.csv as example

Note, if the connection was not good enough, the download may be broken and report the error like: "gzip: GCF_000017765.1_ASM1776v1_genomic.fna.gz: invalid compressed data--format violated"

Also note that, the parsnp will randomly pick a strain as root, which sometimes will give out error. Generally, you can just rerun the parsnp command.



##### The main output as the input for step 4.3

_stat_all.csv: the file with this suffix contains all the statistical values of samples in this dataset, see its example in Example_files folder

_dis_all.csv: the file with this suffix contains all the distance values of samples in this dataset, see its example in Example_files folder

_abun_all.csv: the file with this suffix contains all the strain relative abundance values of samples in this dataset, see its example in Example_files folder

_abun_diff_all.csv: the file with this suffix contains all the strain relative abundance difference compared to ground truth of samples in this dataset, see its example in Example_files folder

_rank_abun_diff_all.csv: the file with this suffix contains all the ranked relative abundance values of samples in this dataset, see its example in Example_files folder

_rank_abun_all.csv: the file with this suffix contains all the ranked relative abundance difference compared to ground truth of samples in this dataset, see its example in Example_files folder

_sorted_JSD_all.csv the file with this suffix contains all the JSD on sorted relative abundance compared to ground truth of samples in this dataset, see its example in Example_files folder

_sorted_RA_all.csv the file with this suffix contains all the sorted relative abundance of samples in this dataset, see its example in Example_files folder

There are some summary plots which are not discussed here in details.



#### 4.3 run comparison among methods/datasets to generate statistic matrices (must be the result from the same ground truth set). If want to compare between different sequencing error types, you must turn all of the samples ID into the same format. For example, errfree and seqerr to WGSerr.

##### If the comparison includes a method like PStrain, only the JSD on sorted relative abundance could be used:

```
Rscript $Path_to_SimStr/SIM_evaluate_across_methods_sJSD.R metadata_f=metadata_f sJSD_all_list_f=sJSD_all_list_f sAb_all_list_f=sAb_all_list_f out_name=outheader
```

metadata_f: the grouping information for samples (such as replicates), see metadata.txt as example. This will affect the output plots. Also only the listed samples in this file will be plotted.

sJSD_all_list_f: the list of all "_sorted_JSD_all.csv" output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See sJSD_all_file_list.txt as example.

sAb_all_list_f:  the list of all "_sorted_RA_all.csv“ output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See sAb_all_file_list.txt as example.

##### Otherwise, all statistical values could be used:

```
Rscript $Path_to_SimStr/SIM_evaluate_across_methods.R metadata_f=metadata_f stat_all_list_f=stat_all_list_f dis_all_list_f=dis_all_list_f RAD_all_list_f=RAD_all_list_f RA_all_list_f=RA_all_list_f Ab_all_list_f=Ab_all_list_f AD_all_list_f=AD_all_list_f out_name=outheader
```

metadata_f: the grouping information for samples (such as replicates), see metadata.txt as example. This will affect the output plots. Also only the listed samples in this file will be plotted.

stat_all_list_f=the list of all "_stat_all.csv“ output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See stat_all_file_list.txt as example.

dis_all_list_f=the list of all "_dis_all.csv" output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See dis_all_file_list.txt as example.

Ab_all_list_f=the list of all "_abun_all.csv:" output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See Abun_all_file_list.txt  as example.

AD_all_list_f=the list of all "_abun_diff_all.csv" output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See abun_diff_all_file_list.txt  as example.

RAD_all_list_f=the list of all "_rank_abun_diff_all.csv“ output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See rank_abun_diff_all_file_list.txt as example.

RA_all_list_f=the list of all "_rank_abun_all.csv" output from 4.2, should be in two columns separated by \t, 1st column is the path and 2nd column is the name of that dataset (could contain both the dataset and method information, such as 1x-EST stands for the StrainEst result for pWGS-1x dataset). See rank_abun_all_file_list.txt as example.

##### Main outputs:

_matr.txt: the file with this suffix contains all the corresponding value for each sample across methods/datasets. For example, in Fig2A_sJSD_s2_XT_EST_4str_sJSD_matr.txt it contains all the JSD on sorted relative abundance compared to ground truth for each dataset-method pair. 

_boxplot.pdf: the corresponding boxplot, which could be control by metadata_f on how to group the box. See Fig2A_sJSD_s2_XT_EST_4str_sJSD_boxplot.pdf as an example.

_stackplot_by_method.pdf: stackplot only for relative abundance (sAB, Ab or RA file) , it is grouped by each method, see as Fig2A_sJSD_s2_XT_EST_4str_sAB_stackplot_by_method.pdf example.

_stackplot_by_group.pdf: stackplot only for relative abundance (sAB, Ab or RA file) , it is grouped by each sample, see as Fig2A_sJSD_s2_XT_EST_4str_sAB_stackplot_by_group.pdf example.
